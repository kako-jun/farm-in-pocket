# Web監視UI 画面構成案

## 概要

Farm in Pocket Web監視UIは、導入されたモジュールの稼働状況を一覧表示し、簡易的なログ確認とシステム管理を行うためのダッシュボードです。

## 技術スタック

### バックエンド
- **Flask** または **FastAPI** （軽量で高速）
- Python 3.9+
- Docker連携（docker-py）
- SQLite（ログ・設定保存用）

### フロントエンド
- **Vue.js 3** （シンプルで学習コストが低い）
- Vue Router（画面遷移）
- Axios（API通信）
- Chart.js（グラフ表示）
- Tailwind CSS（軽量なスタイリング）

## 画面構成

### 1. ダッシュボード（トップページ）

**URL**: `/`

**目的**: 全モジュールの稼働状況を一目で確認

```
┌─────────────────────────────────────────────────────┐
│ 🌾 Farm in Pocket Dashboard                         │
├─────────────────────────────────────────────────────┤
│                                                      │
│ システム情報                                          │
│ ┌─────────────────┬─────────────────┬─────────────┐ │
│ │ CPU使用率: 25%   │ メモリ: 1.2/4GB │ 稼働: 5日   │ │
│ └─────────────────┴─────────────────┴─────────────┘ │
│                                                      │
│ 導入済みモジュール                                    │
│ ┌──────────────────────────────────────────────────┐ │
│ │ ✅ farminpocket-temp         v1.0.0  [稼働中]    │ │
│ │    温度: 24.5℃  湿度: 65%    最終更新: 5分前     │ │
│ ├──────────────────────────────────────────────────┤ │
│ │ ✅ farminpocket-irrigation   v1.0.0  [稼働中]    │ │
│ │    次回散水: 14:30           最終散水: 2時間前   │ │
│ ├──────────────────────────────────────────────────┤ │
│ │ ✅ farminpocket-photo        v1.0.0  [稼働中]    │ │
│ │    撮影枚数: 1,234枚         最終撮影: 1分前     │ │
│ ├──────────────────────────────────────────────────┤ │
│ │ ⚠️  farminpocket-scare       v1.0.0  [警告]      │ │
│ │    センサー異常検知           最終検知: 30秒前   │ │
│ ├──────────────────────────────────────────────────┤ │
│ │ ❌ farminpocket-connect      v1.0.0  [停止中]    │ │
│ │    ネットワーク未接続         エラーログを確認   │ │
│ └──────────────────────────────────────────────────┘ │
│                                                      │
│ [モジュール追加] [システム設定] [ログ確認]            │
└─────────────────────────────────────────────────────┘
```

**表示項目**:
- システムステータス（CPU、メモリ、稼働時間）
- 各モジュールのカード表示
  - モジュール名・バージョン
  - 稼働状態（稼働中 / 警告 / 停止中 / エラー）
  - 主要メトリクス（モジュールごとに異なる）
  - 最終更新時刻

**ステータス表示**:
- 🟢 稼働中（緑）
- 🟡 警告（黄）
- 🔴 エラー（赤）
- ⚫ 停止中（灰色）

---

### 2. モジュール詳細画面

**URL**: `/modules/:module_name`

**目的**: 各モジュールの詳細情報とログを表示

```
┌─────────────────────────────────────────────────────┐
│ ← ダッシュボードに戻る                                │
├─────────────────────────────────────────────────────┤
│ 🌡️ farminpocket-temp                                 │
│ バージョン: v1.0.0                                   │
│ ステータス: ✅ 稼働中                                 │
│                                                      │
│ リアルタイムデータ                                    │
│ ┌──────────────────────────────────────────────────┐ │
│ │ 温度: 24.5℃ ───────────────────── [グラフ]       │ │
│ │ 湿度: 65%   ───────────────────── [グラフ]       │ │
│ └──────────────────────────────────────────────────┘ │
│                                                      │
│ 履歴グラフ（24時間）                                  │
│ ┌──────────────────────────────────────────────────┐ │
│ │      30℃ ┐                                       │ │
│ │      25℃ ├─────╱╲─────╱╲─────                   │ │
│ │      20℃ ┴─────────────────────────              │ │
│ │          0h    6h    12h    18h    24h          │ │
│ └──────────────────────────────────────────────────┘ │
│                                                      │
│ ログ                                                 │
│ ┌──────────────────────────────────────────────────┐ │
│ │ 2025-11-17 15:30:21 [INFO] 温度読取: 24.5℃       │ │
│ │ 2025-11-17 15:29:21 [INFO] 温度読取: 24.3℃       │ │
│ │ 2025-11-17 15:28:21 [INFO] 温度読取: 24.1℃       │ │
│ │ ...                                              │ │
│ └──────────────────────────────────────────────────┘ │
│                                                      │
│ [設定変更] [再起動] [停止] [ログダウンロード]         │
└─────────────────────────────────────────────────────┘
```

**表示項目**:
- モジュール名・バージョン・ステータス
- リアルタイムデータ（センサー値など）
- 履歴グラフ（24時間 / 7日間 / 30日間切替）
- ログ表示（最新100件）
- 操作ボタン（再起動、停止、設定変更）

---

### 3. モジュール管理画面

**URL**: `/modules/manage`

**目的**: モジュールの追加・削除・アップデート

```
┌─────────────────────────────────────────────────────┐
│ ← ダッシュボードに戻る                                │
├─────────────────────────────────────────────────────┤
│ モジュール管理                                        │
│                                                      │
│ 導入済みモジュール                                    │
│ ┌──────────────────────────────────────────────────┐ │
│ │ farminpocket-temp         v1.0.0  [削除] [更新]  │ │
│ │ farminpocket-irrigation   v1.0.0  [削除] [更新]  │ │
│ │ farminpocket-photo        v1.0.0  [削除] [更新]  │ │
│ └──────────────────────────────────────────────────┘ │
│                                                      │
│ 利用可能なモジュール                                  │
│ ┌──────────────────────────────────────────────────┐ │
│ │ farminpocket-scare        v1.0.0  [インストール] │ │
│ │ 害獣監視＋威嚇（光・音）                          │ │
│ ├──────────────────────────────────────────────────┤ │
│ │ farminpocket-connect      v1.0.0  [インストール] │ │
│ │ データ送信（LoRaWAN/Wi-Fi/MQTT）                 │ │
│ └──────────────────────────────────────────────────┘ │
│                                                      │
│ カスタムモジュールの追加                              │
│ ┌──────────────────────────────────────────────────┐ │
│ │ Dockerイメージ: [_________________________]      │ │
│ │ [追加]                                           │ │
│ └──────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

**機能**:
- 導入済みモジュールの一覧
- モジュールの削除・更新
- 新規モジュールのインストール
- カスタムDockerイメージの追加

---

### 4. システム設定画面

**URL**: `/settings`

**目的**: システム全体の設定変更

```
┌─────────────────────────────────────────────────────┐
│ ← ダッシュボードに戻る                                │
├─────────────────────────────────────────────────────┤
│ システム設定                                          │
│                                                      │
│ 基本設定                                             │
│ ┌──────────────────────────────────────────────────┐ │
│ │ デバイス名: [farminpocket-01_______________]      │ │
│ │ タイムゾーン: [Asia/Tokyo ▼]                     │ │
│ │ 言語: [日本語 ▼]                                 │ │
│ └──────────────────────────────────────────────────┘ │
│                                                      │
│ ネットワーク設定                                      │
│ ┌──────────────────────────────────────────────────┐ │
│ │ Wi-Fi SSID: [________________]                   │ │
│ │ パスワード: [________________]                   │ │
│ │ IPアドレス: 192.168.1.100 (自動取得)             │ │
│ └──────────────────────────────────────────────────┘ │
│                                                      │
│ アップデート                                          │
│ ┌──────────────────────────────────────────────────┐ │
│ │ 現在のバージョン: v1.0.0                          │ │
│ │ 自動アップデート: [☑ 有効]                       │ │
│ │ [アップデート確認]                                │ │
│ └──────────────────────────────────────────────────┘ │
│                                                      │
│ システム操作                                          │
│ ┌──────────────────────────────────────────────────┐ │
│ │ [システム再起動] [シャットダウン] [設定初期化]    │ │
│ └──────────────────────────────────────────────────┘ │
│                                                      │
│ [保存]                                               │
└─────────────────────────────────────────────────────┘
```

**設定項目**:
- デバイス名
- タイムゾーン・言語
- Wi-Fi設定
- OTAアップデート設定
- システム操作（再起動、シャットダウン）

---

### 5. ログビューア画面

**URL**: `/logs`

**目的**: システム全体のログを統合表示

```
┌─────────────────────────────────────────────────────┐
│ ← ダッシュボードに戻る                                │
├─────────────────────────────────────────────────────┤
│ システムログ                                          │
│                                                      │
│ フィルター                                           │
│ ┌──────────────────────────────────────────────────┐ │
│ │ モジュール: [すべて ▼]                            │ │
│ │ レベル: [すべて ▼] (INFO/WARNING/ERROR)          │ │
│ │ 期間: [今日 ▼]                                   │ │
│ │ 検索: [_______________________] [🔍]             │ │
│ └──────────────────────────────────────────────────┘ │
│                                                      │
│ ログ一覧                                             │
│ ┌──────────────────────────────────────────────────┐ │
│ │ 2025-11-17 15:30:21 [INFO] [temp] 温度読取       │ │
│ │ 2025-11-17 15:29:45 [WARN] [scare] センサー異常  │ │
│ │ 2025-11-17 15:28:10 [INFO] [irrigation] 散水開始 │ │
│ │ 2025-11-17 15:25:33 [ERROR] [connect] 接続失敗   │ │
│ │ ...                                              │ │
│ │ (ページネーション: < 1 2 3 ... 10 >)             │ │
│ └──────────────────────────────────────────────────┘ │
│                                                      │
│ [ログダウンロード] [ログクリア]                       │
└─────────────────────────────────────────────────────┘
```

**機能**:
- 全モジュールのログ統合表示
- モジュール・レベル・期間でフィルタリング
- キーワード検索
- ログのダウンロード（CSV/JSON形式）

---

## API設計

### エンドポイント一覧

| メソッド | エンドポイント | 説明 |
|---------|--------------|------|
| GET | `/api/system/status` | システム情報取得 |
| GET | `/api/modules` | モジュール一覧取得 |
| GET | `/api/modules/:name` | モジュール詳細取得 |
| POST | `/api/modules/:name/start` | モジュール起動 |
| POST | `/api/modules/:name/stop` | モジュール停止 |
| POST | `/api/modules/:name/restart` | モジュール再起動 |
| POST | `/api/modules/install` | モジュールインストール |
| DELETE | `/api/modules/:name` | モジュール削除 |
| GET | `/api/logs` | ログ取得 |
| GET | `/api/modules/:name/data` | モジュールのリアルタイムデータ取得 |
| PUT | `/api/settings` | システム設定更新 |
| GET | `/api/settings` | システム設定取得 |

### データ形式例

**システムステータス** (`GET /api/system/status`)

```json
{
  "cpu_usage": 25.3,
  "memory_total": 4096,
  "memory_used": 1234,
  "uptime": 432000,
  "timestamp": "2025-11-17T15:30:21Z"
}
```

**モジュール一覧** (`GET /api/modules`)

```json
{
  "modules": [
    {
      "name": "farminpocket-temp",
      "version": "1.0.0",
      "status": "running",
      "description": "温度・湿度監視",
      "metrics": {
        "temperature": 24.5,
        "humidity": 65
      },
      "last_update": "2025-11-17T15:30:21Z"
    },
    {
      "name": "farminpocket-irrigation",
      "version": "1.0.0",
      "status": "running",
      "description": "自動潅水制御",
      "metrics": {
        "next_watering": "2025-11-17T14:30:00Z",
        "last_watering": "2025-11-17T12:30:00Z"
      },
      "last_update": "2025-11-17T15:30:21Z"
    }
  ]
}
```

---

## WebSocket対応

リアルタイムデータ更新のため、WebSocketを利用：

- **接続**: `ws://farminpocket.local/ws`
- **イベント**:
  - `module_status_changed`: モジュールの状態変更
  - `new_data`: 新しいセンサーデータ
  - `new_log`: 新しいログエントリ

**例**:
```json
{
  "event": "new_data",
  "module": "farminpocket-temp",
  "data": {
    "temperature": 24.5,
    "humidity": 65,
    "timestamp": "2025-11-17T15:30:21Z"
  }
}
```

---

## セキュリティ考慮事項

1. **認証**:
   - 初回起動時にパスワード設定
   - JWT認証またはセッション管理

2. **アクセス制御**:
   - ローカルネットワーク内のみアクセス可能（デフォルト）
   - HTTPS対応（Let's Encrypt）

3. **入力検証**:
   - すべてのAPI入力をバリデーション
   - SQLインジェクション対策

---

## 実装優先順位

1. **フェーズ1**: ダッシュボードとモジュール一覧
2. **フェーズ2**: モジュール詳細画面とログビューア
3. **フェーズ3**: モジュール管理機能
4. **フェーズ4**: システム設定とOTAアップデート
5. **フェーズ5**: WebSocketリアルタイム更新

---

## 開発環境セットアップ

```bash
# バックエンド
cd core/web-ui/backend
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python app.py

# フロントエンド
cd core/web-ui/frontend
npm install
npm run dev
```

---

この設計案をもとに、まずはフェーズ1から実装を開始します。
